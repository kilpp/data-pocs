services:
  postgres:
    image: docker.io/library/postgres:15
    container_name: sales-postgres
    environment:
      POSTGRES_DB: sales
      POSTGRES_USER: sales_user
      POSTGRES_PASSWORD: sales_pass
    ports:
      - "5432:5432"
    volumes:
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
      - postgres_data:/var/lib/postgresql/data

  zookeeper:
    image: docker.io/confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  kafka:
    image: docker.io/confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ZOOKEEPER_CONNECTION_TIMEOUT_MS: 60000
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    restart: unless-stopped

  kafka-connect:
    image: docker.io/confluentinc/cp-kafka-connect:7.5.0
    container_name: kafka-connect
    depends_on:
      - kafka
      - postgres
    ports:
      - "8083:8083"
    environment:
      CONNECT_BOOTSTRAP_SERVERS: kafka:29092
      CONNECT_REST_PORT: 8083
      CONNECT_GROUP_ID: "sales-connect"
      CONNECT_CONFIG_STORAGE_TOPIC: _connect-configs
      CONNECT_OFFSET_STORAGE_TOPIC: _connect-offsets
      CONNECT_STATUS_STORAGE_TOPIC: _connect-status
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_REST_ADVERTISED_HOST_NAME: kafka-connect
      CONNECT_PLUGIN_PATH: /usr/share/java,/usr/share/confluent-hub-components
    restart: unless-stopped
    user: "0:0"
    command:
      - bash
      - -c
      - |
        confluent-hub install --no-prompt confluentinc/kafka-connect-jdbc:10.7.4
        confluent-hub install --no-prompt jcustenborder/kafka-connect-spooldir:2.0.65
        mkdir -p /data/spool/input /data/spool/finished /data/spool/error
        /etc/confluent/docker/run
    volumes:
      - ./spool:/data/spool

  connector-init:
    image: docker.io/confluentinc/cp-kafka-connect:7.5.0
    container_name: connector-init
    depends_on:
      - kafka-connect
    restart: "no"
    volumes:
      - ./spool:/data/spool
      - ./connectors:/data/connectors
    command:
      - bash
      - -c
      - |
        echo "Creating spool directories..."
        mkdir -p /data/spool/input /data/spool/finished /data/spool/error
        echo "Waiting for Kafka Connect..."
        until curl -s http://kafka-connect:8083/connectors > /dev/null 2>&1; do
          sleep 5
        done
        echo "Kafka Connect is ready."
        echo "Registering JDBC connector..."
        curl -s -X POST http://kafka-connect:8083/connectors \
          -H "Content-Type: application/json" \
          -d @/data/connectors/jdbc-source.json
        echo ""
        echo "Registering SpoolDir connector..."
        curl -s -X POST http://kafka-connect:8083/connectors \
          -H "Content-Type: application/json" \
          -d @/data/connectors/csv-source.json
        echo ""
        echo "All connectors registered. Done."

  data-generator:
    image: docker.io/sbtscala/scala-sbt:amazoncorretto-al2023-17.0.16_1.12.3_2.13.18
    container_name: data-generator
    depends_on:
      - postgres
    working_dir: /app
    volumes:
      - ./data-generator:/app
      - sbt_cache_data_gen:/root/.sbt
      - ivy_cache_data_gen:/root/.cache
    environment:
      DB_URL: jdbc:postgresql://postgres:5432/sales
      DB_USER: sales_user
      DB_PASSWORD: sales_pass
      INTERVAL_MS: "1000"
      BATCH_SIZE: "50"
    command: sbt run
    restart: unless-stopped

  file-generator:
    image: docker.io/sbtscala/scala-sbt:amazoncorretto-al2023-17.0.16_1.12.3_2.13.18
    container_name: file-generator
    working_dir: /app
    volumes:
      - ./file-generator:/app
      - ./spool:/data/spool
      - sbt_cache_file_gen:/root/.sbt
      - ivy_cache_file_gen:/root/.cache
    environment:
      OUTPUT_DIR: /data/spool/input
      INTERVAL_MS: "5000"
      ROWS_PER_FILE: "50"
    command: sbt run
    restart: unless-stopped

  soap-server:
    image: docker.io/sbtscala/scala-sbt:amazoncorretto-al2023-17.0.16_1.12.3_2.13.18
    container_name: soap-server
    working_dir: /app
    volumes:
      - ./soap-server:/app
      - sbt_cache_server:/root/.sbt
      - ivy_cache_server:/root/.cache
    ports:
      - "8089:8089"
    environment:
      PORT: "8089"
      BATCH_SIZE: "50"
    command: sbt run
    restart: unless-stopped

  soap-connector:
    image: docker.io/sbtscala/scala-sbt:amazoncorretto-al2023-17.0.16_1.12.3_2.13.18
    container_name: soap-connector
    depends_on:
      - kafka
      - soap-server
    working_dir: /app
    volumes:
      - ./soap-connector:/app
      - sbt_cache_connector:/root/.sbt
      - ivy_cache_connector:/root/.cache
    environment:
      SOAP_URL: http://soap-server:8089/ws/sales
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      TOPIC: sales-sales_transactions
      POLL_INTERVAL_MS: "5000"
    command: sbt run
    restart: unless-stopped

  kafka-ui:
    image: docker.io/provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      - kafka
      - kafka-connect
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      KAFKA_CLUSTERS_0_KAFKACONNECT_0_NAME: connect
      KAFKA_CLUSTERS_0_KAFKACONNECT_0_ADDRESS: http://kafka-connect:8083

volumes:
  postgres_data:
  sbt_cache_data_gen:
  ivy_cache_data_gen:
  sbt_cache_file_gen:
  ivy_cache_file_gen:
  sbt_cache_server:
  ivy_cache_server:
  sbt_cache_connector:
  ivy_cache_connector:
